---
import Nav from "../../components/Nav.astro";
import Layout from "../../layouts/Layout.astro";

import { Search } from "lucide-astro";
---

<Layout title="weather.aapelix.dev">
  <Nav tab="search" />
  <main class="w-screen flex justify-center items-center h-[35vh]">
    <div class="max-w-2/3">
      <div class="flex gap-2">
        <input
          type="search"
          id="searchbar"
          class="p-3 px-4 bg-text w-[30rem] text-background rounded-full outline-none border-none"
          placeholder="Search..."
        />
        <button id="search-btn"><Search /></button>
      </div>
      <div
        id="results-container"
        class="bg-text py-3 mt-2 w-[30rem] text-background rounded-3xl"
      >
        <ul id="results" class="m-3 my-2"></ul>
      </div>
    </div>
  </main>
</Layout>

<script>
  const apiKey = import.meta.env.PUBLIC_API_KEY;
  const search = document.getElementById("searchbar");
  const results = document.getElementById("results");
  const searchBtn = document.getElementById("search-btn");

  let q = "";

  var delay = 200;
  var lastClick = 0;

  async function handleInput(query: string) {
    if (lastClick >= Date.now() - delay && query.length !== 0) return;

    lastClick = Date.now();

    if (query.length > 2) {
      const response = await fetch(
        `https://api.weatherapi.com/v1/search.json?key=` +
          apiKey +
          "&q=" +
          query
      );

      const data = await response.json();
      displayResults(data);
      console.log(data);
    } else if (query.length <= 0) {
      displayResults([]);
    }
  }

  function displayResults(data: any[]) {
    if (!results) return;

    results.innerHTML = "";

    data.forEach((item) => {
      const li = document.createElement("li");
      li.textContent = item.name + ", " + item.country;
      li.style.cursor = "pointer";

      li.addEventListener("click", () => {
        location.assign("/search/weather/" + item.lon + "-" + item.lat);
      });

      results.appendChild(li);
    });
  }

  search?.addEventListener(
    "input",
    (event) => {
      // @ts-expect-error
      const query = event.target.value;
      // @ts-expect-error
      q = event.target.value;
      handleInput(query);
    },
    false
  );

  searchBtn?.addEventListener("click", async () => {
    if (q.length >= 2) {
      const response = await fetch(
        `https://api.weatherapi.com/v1/search.json?key=` + apiKey + "&q=" + q
      );

      const data = await response.json();
      console.log(data);

      const lon = data[0].lon;
      const lat = data[0].lat;

      location.assign("/search/weather/" + lon + "-" + lat);
    }
  });
</script>
